---
# Role: Configure Kubernetes
# Purpose: Install kubeadm, kubelet, kubectl and prepare K8s environment

- name: Prerequisites for Kubernetes
  block:
    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab
      changed_when: false
      ignore_errors: yes

    - name: Load required kernel modules
      shell: |
        cat >> /etc/modules-load.d/kubernetes.conf <<EOF
        overlay
        br_netfilter
        EOF
        modprobe overlay
        modprobe br_netfilter
      changed_when: false
      ignore_errors: yes

    - name: Configure kernel parameters
      shell: |
        cat >> /etc/sysctl.d/kubernetes.conf <<EOF
        net.bridge.bridge-nf-call-iptables = 1
        net.bridge.bridge-nf-call-ip6tables = 1
        net.ipv4.ip_forward = 1
        EOF
        sysctl -p /etc/sysctl.d/kubernetes.conf
      changed_when: false
      ignore_errors: yes

  tags:
    - kubernetes
    - kubernetes_prereq

- name: Install containerd container runtime
  block:
    - name: Install containerd on Debian/Ubuntu
      apt:
        name: containerd.io
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install containerd on RedHat/CentOS
      yum:
        name: containerd.io
        state: present
      when: ansible_os_family == "RedHat"

    - name: Create containerd configuration directory
      file:
        path: /etc/containerd
        state: directory
        mode: '0755'

    - name: Generate containerd default configuration
      shell: containerd config default > /etc/containerd/config.toml
      changed_when: false
      ignore_errors: yes

    - name: Update containerd configuration for systemd cgroup
      shell: |
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      changed_when: false

    - name: Start and enable containerd
      systemd:
        name: containerd
        enabled: yes
        state: started
        daemon_reload: yes

  tags:
    - kubernetes
    - containerd

- name: Install Kubernetes tools
  block:
    - name: Add Kubernetes apt key (Debian/Ubuntu)
      block:
        - name: Download Google Cloud public key
          apt_key:
            url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
            state: present

        - name: Add Kubernetes repository
          apt_repository:
            repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
            state: present

        - name: Install kubelet, kubeadm, kubectl
          apt:
            name:
              - kubelet
              - kubeadm
              - kubectl
            state: present
            update_cache: yes
          register: k8s_install
          until: k8s_install is succeeded
          retries: 3
          delay: 10

      when: ansible_os_family == "Debian"

    - name: Add Kubernetes yum key (RedHat/CentOS)
      block:
        - name: Add Kubernetes repository
          yum_repository:
            name: kubernetes
            description: Kubernetes
            baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
            gpgcheck: yes
            gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/rpm-package-key.gpg
            enabled: yes

        - name: Install kubelet, kubeadm, kubectl
          yum:
            name:
              - kubelet
              - kubeadm
              - kubectl
            state: present

      when: ansible_os_family == "RedHat"

  tags:
    - kubernetes
    - kubernetes_tools

- name: Configure kubelet
  block:
    - name: Enable and start kubelet service
      systemd:
        name: kubelet
        enabled: yes
        daemon_reload: yes
      register: kubelet_service
      until: kubelet_service is succeeded
      retries: 3

    - name: Create kubelet configuration directory
      file:
        path: /etc/kubernetes
        state: directory
        mode: '0755'

  tags:
    - kubernetes
    - kubelet

- name: Verify Kubernetes installation
  block:
    - name: Check kubelet version
      shell: kubelet --version
      register: kubelet_version
      changed_when: false

    - name: Check kubeadm version
      shell: kubeadm version -o short
      register: kubeadm_version
      changed_when: false

    - name: Check kubectl version
      shell: kubectl version --client --short
      register: kubectl_version
      changed_when: false
      ignore_errors: yes

    - name: Display Kubernetes installation info
      debug:
        msg: |
          Kubernetes Installation Successful!
          - {{ kubelet_version.stdout }}
          - {{ kubeadm_version.stdout }}
          - {{ kubectl_version.stdout }}

  tags:
    - kubernetes
    - verify

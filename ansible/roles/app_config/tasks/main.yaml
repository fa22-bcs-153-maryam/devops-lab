---
# Role: Deploy Application Configuration
# Purpose: Configure environment variables, secrets, and application settings

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/devops-lab
    - /opt/devops-lab/config
    - /var/log/devops-lab
    - /etc/devops-lab
  tags:
    - app_config
    - directories

- name: Deploy environment configuration
  block:
    - name: Create .env file
      copy:
        content: |
          # Application Configuration
          NODE_ENV={{ app_environment }}
          APP_NAME={{ app_name }}
          APP_VERSION={{ app_version }}

          # Server Configuration
          API_PORT={{ api_port | default(4000) }}
          API_HOST=0.0.0.0

          # Database Configuration
          DATABASE_HOST={{ db_host | default('localhost') }}
          DATABASE_PORT={{ db_port | default(5432) }}
          DATABASE_NAME={{ db_name | default('devops_lab') }}
          DATABASE_USER={{ db_user | default('postgres') }}
          DATABASE_PASSWORD={{ db_password | default('postgres') }}
          DATABASE_URL=postgresql://{{ db_user | default('postgres') }}:{{ db_password | default('postgres') }}@{{ db_host | default('localhost') }}:{{ db_port | default(5432) }}/{{ db_name | default('devops_lab') }}

          # Redis Configuration
          REDIS_HOST={{ redis_host | default('localhost') }}
          REDIS_PORT={{ redis_port | default(6379) }}
          REDIS_PASSWORD={{ redis_password | default('') }}

          # Logging
          LOG_LEVEL={{ log_level | default('info') }}
          LOG_FORMAT=json

          # Docker Registry
          DOCKER_REGISTRY={{ docker_registry | default('docker.io') }}
          DOCKER_IMAGE_API={{ docker_image_api | default('devops-lab-api') }}
          DOCKER_IMAGE_FRONTEND={{ docker_image_frontend | default('devops-lab-frontend') }}
          DOCKER_IMAGE_TAG={{ docker_image_tag | default('latest') }}

          # Kubernetes
          KUBERNETES_CLUSTER_NAME={{ kubernetes_cluster_name | default('devops-lab-prod') }}
          KUBERNETES_NAMESPACE={{ kubernetes_namespace | default('default') }}

        dest: /etc/devops-lab/.env
        mode: '0600'
      no_log: true
      tags:
        - app_config
        - env

    - name: Create application config file
      copy:
        content: |
          # DevOps Lab Application Configuration
          # Generated by Ansible

          application:
            name: {{ app_name }}
            version: {{ app_version }}
            environment: {{ app_environment }}

          server:
            port: {{ api_port | default(4000) }}
            host: 0.0.0.0
            workers: {{ api_workers | default(4) }}

          database:
            host: {{ db_host | default('localhost') }}
            port: {{ db_port | default(5432) }}
            name: {{ db_name | default('devops_lab') }}
            user: {{ db_user | default('postgres') }}
            pool_size: 10
            timeout: 30

          redis:
            host: {{ redis_host | default('localhost') }}
            port: {{ redis_port | default(6379) }}
            db: 0

          logging:
            level: {{ log_level | default('info') }}
            format: json
            output: both  # both console and file

          features:
            caching_enabled: true
            compression_enabled: true
            cors_enabled: true

        dest: /etc/devops-lab/config.yaml
        mode: '0644'
      tags:
        - app_config
        - config

  tags:
    - app_config
    - config_files

- name: Create sample application files
  block:
    - name: Create sample index.ts
      copy:
        content: |
          // Sample DevOps Lab API Server
          // Generated by Ansible

          const express = require('express');
          const app = express();

          const PORT = process.env.API_PORT || 4000;

          app.use(express.json());

          // Health check endpoint
          app.get('/health', (req, res) => {
            res.status(200).json({
              status: 'healthy',
              timestamp: new Date().toISOString(),
              service: 'devops-lab-api',
              version: process.env.APP_VERSION || '1.0.0'
            });
          });

          // API endpoints
          app.get('/api', (req, res) => {
            res.json({ message: 'DevOps Lab API' });
          });

          app.listen(PORT, () => {
            console.log(`API server running on port ${PORT}`);
          });

          module.exports = app;
        dest: /opt/devops-lab/app/index.ts
        mode: '0644'
      ignore_errors: yes
      tags:
        - app_config
        - app_files

    - name: Create sample package.json
      copy:
        content: |
          {
            "name": "devops-lab-api",
            "version": "1.0.0",
            "description": "DevOps Lab API Server",
            "main": "dist/index.js",
            "scripts": {
              "build": "tsc",
              "start": "node dist/index.js",
              "dev": "ts-node src/index.ts"
            },
            "dependencies": {
              "express": "^4.18.2"
            },
            "devDependencies": {
              "typescript": "^5.2.2",
              "@types/node": "^20.5.0",
              "@types/express": "^4.17.17"
            }
          }
        dest: /opt/devops-lab/package.json
        mode: '0644'
      ignore_errors: yes
      tags:
        - app_config
        - app_files

  tags:
    - app_config
    - app_files

- name: Install and build application
  block:
    - name: Install npm dependencies
      shell: |
        cd /opt/devops-lab
        npm install
      ignore_errors: yes
      tags:
        - app_config
        - dependencies

    - name: Build TypeScript
      shell: |
        cd /opt/devops-lab
        npm run build
      ignore_errors: yes
      tags:
        - app_config
        - build

  tags:
    - app_config
    - install

- name: Set up application logging
  block:
    - name: Create log directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/log/devops-lab
        - /var/log/devops-lab/app
        - /var/log/devops-lab/system
      ignore_errors: yes

    - name: Set up log rotation
      copy:
        content: |
          /var/log/devops-lab/*.log {
            daily
            rotate 7
            compress
            delaycompress
            notifempty
            create 0640 root root
            sharedscripts
          }
        dest: /etc/logrotate.d/devops-lab
        mode: '0644'
      ignore_errors: yes

  tags:
    - app_config
    - logging

- name: Set file permissions
  block:
    - name: Set ownership for application directory
      file:
        path: /opt/devops-lab
        mode: '0755'
        recurse: yes
      ignore_errors: yes

    - name: Make scripts executable
      shell: |
        chmod +x /opt/devops-lab/*.sh 2>/dev/null || true
      ignore_errors: yes

  tags:
    - app_config
    - permissions

- name: Verify application configuration
  block:
    - name: Check environment file exists
      stat:
        path: /etc/devops-lab/.env
      register: env_file

    - name: Check config file exists
      stat:
        path: /etc/devops-lab/config.yaml
      register: config_file

    - name: Display configuration status
      debug:
        msg: |
          Application Configuration Deployed!
          - Environment file: {{ env_file.stat.exists | ternary('✓', '✗') }}
          - Config file: {{ config_file.stat.exists | ternary('✓', '✗') }}
          - Application directory: /opt/devops-lab
          - Log directory: /var/log/devops-lab

  tags:
    - app_config
    - verify
